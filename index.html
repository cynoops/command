<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    http-equiv="Content-Security-Policy"
    content="default-src 'self'; style-src 'self' 'unsafe-inline' https://api.mapbox.com; img-src 'self' data: blob: https://api.mapbox.com https://*.tiles.mapbox.com; font-src 'self' data: https://api.mapbox.com; script-src 'self'; connect-src 'self' data: blob: https://api.mapbox.com https://*.tiles.mapbox.com https://events.mapbox.com https://maps.googleapis.com https://places.googleapis.com https://geocoding.googleapis.com; worker-src 'self' blob:;"
  />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Command - CYNOOPS</title>

  <!-- Your main app styles -->
  <link rel="stylesheet" href="./styles.css" />

  <!-- Mapbox GL CSS (bundled locally into dist/vendor) -->
  <link rel="stylesheet" href="./dist/vendor/mapbox-gl/mapbox-gl.css" />
</head>
<body>
  <div class="app">

    <!-- Header -->
    <header class="app-header">
      <nav class="main-menu" role="tablist" aria-label="Main view">
        <label class="tab" for="tab-map" role="tab" aria-controls="view-map" aria-selected="true">MAP</label>
        <label class="tab" for="tab-settings" role="tab" aria-controls="view-settings" aria-selected="false">Settings</label>
      </nav>

      <div class="app-toolbar" role="toolbar" aria-label="Map tools">
        <button id="toolSearch" class="tool-btn" title="Search address" aria-pressed="false">
          <img class="icon" src="./assets/icons/regular/magnifying-glass.svg" alt="" aria-hidden="true" />
        </button>
        <button id="toolGoTo" class="tool-btn" title="Go to coordinates" aria-pressed="false">
          <img class="icon" src="./assets/icons/regular/map-pin-line.svg" alt="" aria-hidden="true" />
        </button>
        <div class="tool-divider" aria-hidden="true"></div>
        <!-- View controls -->
        <button id="toolZoomIn" class="tool-btn" title="Zoom in">
          <img class="icon" src="./assets/icons/regular/plus.svg" alt="" aria-hidden="true" />
        </button>
        <button id="toolZoomOut" class="tool-btn" title="Zoom out">
          <img class="icon" src="./assets/icons/regular/minus.svg" alt="" aria-hidden="true" />
        </button>
        <button id="toolResetView" class="tool-btn" title="Reset bearing & pitch">
          <img class="icon" src="./assets/icons/regular/compass.svg" alt="" aria-hidden="true" />
        </button>
        <button id="toolPin" class="tool-btn" title="Pin/unpin map" aria-pressed="false">
          <img class="icon" src="./assets/icons/regular/lock.svg" alt="" aria-hidden="true" />
        </button>
        <div class="tool-divider" aria-hidden="true"></div>
        <button id="toolRect" class="tool-btn" title="Draw rectangle" aria-pressed="false">
          <img class="icon" src="./assets/icons/regular/bounding-box.svg" alt="" aria-hidden="true" />
        </button>
        <button id="toolPoly" class="tool-btn" title="Draw polygon" aria-pressed="false">
          <img class="icon" src="./assets/icons/regular/polygon.svg" alt="" aria-hidden="true" />
        </button>
        <button id="toolCircle" class="tool-btn" title="Draw circle" aria-pressed="false">
          <img class="icon" src="./assets/icons/regular/circle.svg" alt="" aria-hidden="true" />
        </button>
        <button id="toolLine" class="tool-btn" title="Draw polyline" aria-pressed="false">
          <img class="icon" src="./assets/icons/regular/line-segments.svg" alt="" aria-hidden="true" />
        </button>
        <!-- POI button sits next to Line -->
        <button id="toolPOI" class="tool-btn" title="Add POI" aria-pressed="false">
          <img class="icon" src="./assets/icons/regular/map-pin-plus.svg" alt="" aria-hidden="true" />
        </button>
        <div class="tool-spacer"></div>
      </div>

      <div class="actions">
        <button id="serialConnectBtn" class="serial-btn" title="Connect to serial port" aria-label="Connect to serial port">
          <img class="icon" src="./assets/icons/regular/usb.svg" alt="" aria-hidden="true" />
          <span class="serial-label">Connect</span>
          <span id="serialStatusDot" class="status-dot" data-state="disconnected" aria-live="polite"></span>
        </button>
        <button id="serialMonitorBtn" class="serial-btn" title="Open serial monitor" aria-label="Open serial monitor" hidden>
          <img class="icon" src="./assets/icons/regular/monitor.svg" alt="" aria-hidden="true" />
          <span class="serial-label">Serial Monitor</span>
        </button>
        <button id="fullscreenBtn" class="serial-btn" title="Toggle full screen" aria-label="Toggle full screen">
          <img class="icon" src="./assets/icons/regular/corners-out.svg" alt="" aria-hidden="true" />
          <span class="serial-label">Full Screen</span>
        </button>
      </div>
    </header>

    <!-- Tabs (CSS-only) moved out of header so CSS sibling selectors work -->
    <input id="tab-map" type="radio" name="main-tabs" class="tab-input" checked />
    <input id="tab-settings" type="radio" name="main-tabs" class="tab-input" />



    <!-- Main content -->
    <main class="app-main">
      <!-- MAP VIEW -->
      <section id="view-map" class="view view-map" role="tabpanel" aria-labelledby="tab-map">
        <div id="mapWelcome" class="map-welcome" hidden>
          <div class="map-welcome-card" role="dialog" aria-labelledby="mapWelcomeTitle" aria-describedby="mapWelcomeDesc">
            <h2 id="mapWelcomeTitle">Welcome to CynoOps Command</h2>
            <p id="mapWelcomeDesc">To start exploring the map, add your Mapbox access token under <strong>Settings → API Keys</strong>. Once saved, the map will load automatically.</p>
            <ul class="map-welcome-todo">
              <li>Sign in at <a href="https://account.mapbox.com" target="_blank" rel="noopener">mapbox.com</a> and copy a public access token.</li>
              <li>Open the Settings tab and paste the token into the Mapbox Access Token field.</li>
              <li>Press <em>Save Settings</em> to initialize the map.</li>
            </ul>
            <div class="map-welcome-actions">
              <button id="mapWelcomeSettings" class="btn btn-primary" type="button">Open Settings</button>
            </div>
          </div>
        </div>
        <div id="map" class="map-container" aria-label="Interactive map">
          <!-- Crosshair overlay (placed inside container so it's always centered) -->
          <div id="mapCrosshair" class="map-crosshair" aria-hidden="true"></div>
        </div>
        <!-- Location inputs panel removed -->
        <!-- Sidebar: Features -->
        <aside id="featuresSidebar" class="features-sidebar" aria-label="Features panel" hidden>
          <div class="features-header">
            <span class="features-title">Features</span>
            <button id="featuresCollapse" class="btn-icon" title="Hide sidebar" aria-label="Hide sidebar">⟨</button>
          </div>
          <div id="drawingsList" class="features-list" aria-live="polite"></div>
          <div id="featuresActions" class="features-actions">
            <button id="featuresActionsToggle" class="features-actions-trigger" type="button" aria-haspopup="true" aria-expanded="false">
              <img src="./assets/icons/regular/dots-three-circle-vertical.svg" alt="" class="icon" aria-hidden="true" />
              <span class="visually-hidden">Open features menu</span>
            </button>
            <div id="featuresActionsMenu" class="features-actions-menu" role="menu" hidden>
              <button id="featuresSaveBtn" class="features-menu-btn" type="button" role="menuitem">
                <img src="./assets/icons/regular/file-text.svg" alt="" class="icon" aria-hidden="true" />
                <span>Save</span>
              </button>
              <button id="featuresLoadBtn" class="features-menu-btn" type="button" role="menuitem">
                <img src="./assets/icons/regular/folder-open.svg" alt="" class="icon" aria-hidden="true" />
                <span>Load</span>
              </button>
              <button id="featuresClearBtn" class="features-menu-btn" type="button" role="menuitem">
                <img src="./assets/icons/regular/broom.svg" alt="" class="icon" aria-hidden="true" />
                <span>Clear</span>
              </button>
            </div>
          </div>
          <div id="featuresResizer" class="features-resizer" title="Drag to resize" aria-hidden="true"></div>
        </aside>
        <button id="featuresToggleBtn" class="sidebar-toggle sidebar-toggle-left" type="button" aria-controls="featuresSidebar" aria-expanded="false">
          <img src="./assets/icons/regular/caret-right.svg" alt="" class="icon icon-chevron" aria-hidden="true" />
          <span class="sidebar-toggle-label">FEATURES</span>
          <img src="./assets/icons/regular/polygon.svg" alt="" class="icon" aria-hidden="true" />
          <span class="visually-hidden">Show features panel</span>
        </button>
        <aside id="trackersSidebar" class="trackers-sidebar" aria-label="Trackers panel" hidden>
          <div class="trackers-header">
            <span class="trackers-title">Trackers</span>
            <div class="trackers-header-actions">
              <span id="trackersRecordIndicator" class="trackers-record-indicator" hidden aria-hidden="true">
                <img src="./assets/icons/regular/record.svg" alt="" class="icon" aria-hidden="true" />
              </span>
              <button id="trackersCollapse" class="btn-icon" title="Hide tracker sidebar" aria-label="Hide tracker sidebar">⟩</button>
            </div>
          </div>
          <div id="trackersList" class="trackers-list" aria-live="polite">
            <div id="trackersEmpty" class="trackers-empty">
              <div>No trackers connected yet.</div>
              <button id="trackersConnectBtn" class="btn btn-primary trackers-connect" type="button">
                <img src="./assets/icons/regular/usb.svg" alt="" class="icon" aria-hidden="true" />
                <span>Connect</span>
              </button>
            </div>
            <div id="trackersWaiting" class="trackers-waiting" hidden>
              <span class="trackers-spinner" aria-hidden="true"></span>
              <span>Waiting for trackers…</span>
            </div>
            <div id="trackersItems" class="trackers-items"></div>
          </div>
          <div id="trackersControls" class="trackers-controls" hidden>
            <button id="trackersRecordBtn" class="btn trackers-record-btn" type="button">
              <img id="trackersRecordIcon" src="./assets/icons/regular/record.svg" alt="" class="icon" aria-hidden="true" />
              <span id="trackersRecordText">Record</span>
            </button>
            <div id="trackersMenuWrapper" class="trackers-menu-wrapper">
              <button id="trackersMenuToggle" class="trackers-menu-trigger" type="button" aria-haspopup="true" aria-expanded="false">
                <img src="./assets/icons/regular/dots-three-circle-vertical.svg" alt="" class="icon" aria-hidden="true" />
                <span class="visually-hidden">Open tracker menu</span>
              </button>
              <div id="trackersMenu" class="trackers-menu" role="menu" hidden>
                <button id="trackersSaveBtn" class="trackers-menu-btn" type="button" role="menuitem" disabled>
                  <img src="./assets/icons/regular/file-text.svg" alt="" class="icon" aria-hidden="true" />
                  <span>Save</span>
                </button>
                <button id="trackersOpenBtn" class="trackers-menu-btn" type="button" role="menuitem">
                  <img src="./assets/icons/regular/folder-open.svg" alt="" class="icon" aria-hidden="true" />
                  <span>Open</span>
                </button>
              </div>
            </div>
          </div>
        </aside>
        <button id="trackersToggleBtn" class="sidebar-toggle sidebar-toggle-right" type="button" aria-controls="trackersSidebar" aria-expanded="false">
          <img src="./assets/icons/regular/caret-left.svg" alt="" class="icon icon-chevron" aria-hidden="true" />
          <span class="sidebar-toggle-label">TRACKERS</span>
          <img src="./assets/icons/regular/air-traffic-control.svg" alt="" class="icon" aria-hidden="true" />
          <span class="visually-hidden">Show trackers panel</span>
        </button>
        <!-- Serial monitor moved to modal -->
        <!-- You’ll initialize the map in your preload/renderer JS and update footer stats by ID -->
      </section>

      <!-- SETTINGS VIEW -->
      <section id="view-settings" class="view view-settings" role="tabpanel" aria-labelledby="tab-settings">
        <div class="panel settings-panel">
          <h2>Settings</h2>
          <form id="settingsForm" class="settings-form">
            <div class="settings-group">
              <h3>API Keys</h3>
              <div class="settings-fields">
                <label class="field">
                  <span class="label label-with-help">Mapbox Access Token
                    <button type="button" class="label-help" aria-label="Where to find your Mapbox access token" data-tooltip="Sign in at mapbox.com, open your account dashboard, and copy a public access token.">info</button>
                  </span>
                  <input id="settingAccessToken" type="password" autocomplete="off" placeholder="pk.•••" />
                </label>
                <label class="field">
                  <span class="label label-with-help">Google Maps API Key
                    <button type="button" class="label-help" aria-label="How to get a Google Maps API key" data-tooltip="Use the Google Cloud Console to create a project, enable Maps JavaScript & Places APIs, then create an API key under Credentials.">info</button>
                  </span>
                  <input id="settingGoogleKey" type="password" autocomplete="off" placeholder="AIza•••" />
                </label>
                <label class="field">
                  <span class="label label-with-help">OpenAI API Key
                    <button type="button" class="label-help" aria-label="How to get an OpenAI API key" data-tooltip="Go to platform.openai.com/account/api-keys, create a new secret key, and paste it here.">info</button>
                  </span>
                  <input id="settingOpenAIKey" type="password" autocomplete="off" placeholder="sk-•••" />
                </label>
              </div>
            </div>

            <div class="settings-group">
              <h3>Map Settings</h3>
              <div class="settings-fields">
                <label class="field">
                  <span class="label">Map Style URL</span>
                  <input id="settingStyleUrl" type="text" placeholder="mapbox://styles/your-style-id" />
                </label>
                <label class="field">
                  <span class="label">Home Address</span>
                  <input id="settingHomeAddress" type="text" placeholder="e.g., 1600 Amphitheatre Parkway, Mountain View, CA" />
                </label>
                <label class="field">
                  <span class="label">Start Latitude</span>
                  <input id="settingStartLat" type="number" step="0.000001" min="-90" max="90" placeholder="49.610000" value="49.610000" />
                </label>
                <label class="field">
                  <span class="label">Start Longitude</span>
                  <input id="settingStartLng" type="number" step="0.000001" min="-180" max="180" placeholder="6.130000" value="6.130000" />
                </label>
                <label class="field">
                  <span class="label">Start Zoom</span>
                  <input id="settingStartZoom" type="number" min="0" max="22" step="0.1" value="12" />
                </label>
              </div>
            </div>

            <div class="settings-group">
              <h3>Serial Connections</h3>
              <div class="settings-fields">
                <label class="field">
                  <span class="label">Serial Baud Rate</span>
                  <input id="settingBaud" type="number" step="1" placeholder="115200" />
                </label>
                <label class="field">
                  <span class="label">Auto-reconnect Serial</span>
                  <select id="settingAutoReconnect">
                    <option value="off">Off</option>
                    <option value="on">On</option>
                  </select>
                </label>
              </div>
            </div>

            <div class="settings-actions">
              <span class="settings-status" aria-live="polite"></span>
              <button id="settingsSaveBtn" class="btn btn-primary" type="submit" disabled>Save Settings</button>
            </div>
          </form>
        </div>
      </section>
    </main>

    <!-- Footer: map & data stats -->
    <footer class="app-footer" aria-live="polite">
      <div class="stat"><span class="k">Lat/Long</span><span id="statCenter" class="v">—</span></div>
      <div class="stat"><span class="k">Zoom</span><span id="statZoom" class="v">—</span></div>
      <div class="stat"><span class="k">Bearing</span><span id="statBearing" class="v">—</span></div>
      <div class="stat"><span class="k">Pitch</span><span id="statPitch" class="v">—</span></div>
      <!-- Removed: Layer, Serial, RX -->
      <div class="stat" style="justify-self:end; text-align:right;">
        <span class="k">Address</span>
        <span id="footerAddress" class="v">—</span>
      </div>
    </footer>
    <div id="toastContainer" class="toast-container" aria-live="polite"></div>
  </div>

  <!-- Connect Modal -->
  <div id="connectModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="connectTitle" hidden>
    <div class="modal-backdrop" data-action="close"></div>
    <div class="modal-panel">
      <div class="modal-header">
        <h3 id="connectTitle">Connect to Serial Port</h3>
        <button id="connectClose" class="btn-icon" title="Close">×</button>
      </div>
      <div class="modal-body">
        <div id="portsContainer" class="ports-list" role="listbox" aria-label="Available serial ports">
          <div class="muted">Scanning ports…</div>
        </div>
        <div class="modal-row">
          <label class="field small">
            <span class="label">Baud</span>
            <input id="connectBaud" type="number" value="115200" />
          </label>
          <div class="spacer"></div>
          <button id="refreshPorts" class="btn">Refresh</button>
          <button id="connectBtnAction" class="btn btn-primary">Connect to port</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Search Modal -->
  <div id="searchModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="searchTitle" hidden>
    <div class="modal-backdrop" data-action="close"></div>
    <div class="modal-panel">
      <div class="modal-header">
        <h3 id="searchTitle">Search Address</h3>
        <button id="searchClose" class="btn-icon" title="Close">×</button>
      </div>
      <div class="modal-body">
        <label class="field">
          <span class="label">Address</span>
          <input id="searchQuery" type="text" placeholder="Type an address" autocomplete="off" />
        </label>
        <div id="searchResults" class="search-results" role="listbox" aria-label="Search results"></div>
      </div>
    </div>
  </div>

  <!-- Go To Coordinates Modal -->
  <div id="gotoModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="gotoTitle" hidden>
    <div class="modal-backdrop" data-action="close"></div>
    <div class="modal-panel">
      <div class="modal-header">
        <h3 id="gotoTitle">Go to coordinates</h3>
        <button id="gotoClose" class="btn-icon" title="Close">×</button>
      </div>
      <div class="modal-body">
        <div class="goto-fields">
          <label class="field">
            <span class="label">Latitude</span>
            <input id="gotoLat" type="number" step="0.000001" min="-90" max="90" placeholder="e.g., 49.6100" />
          </label>
          <label class="field">
            <span class="label">Longitude</span>
            <input id="gotoLng" type="number" step="0.000001" min="-180" max="180" placeholder="e.g., 6.1300" />
          </label>
        </div>
        <div class="switch-field">
          <span id="gotoAddPoiLabel" class="label">Add POI at this location</span>
          <label class="switch">
            <input id="gotoAddPoi" type="checkbox" role="switch" aria-labelledby="gotoAddPoiLabel" aria-checked="false" />
            <span class="switch-track"><span class="switch-handle"></span></span>
          </label>
        </div>
        <label id="gotoPoiNameField" class="field" hidden>
          <span class="label">POI name</span>
          <input id="gotoPoiName" type="text" placeholder="Optional name" />
        </label>
        <div class="modal-row">
          <div class="spacer"></div>
          <button id="gotoSubmit" class="btn btn-primary">Go</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Color Picker Modal -->
  <div id="colorModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="colorTitle" hidden>
    <div class="modal-backdrop" data-action="close"></div>
    <div class="modal-panel">
      <div class="modal-header">
        <h3 id="colorTitle">Pick Color</h3>
        <button id="colorClose" class="btn-icon" title="Close">×</button>
      </div>
      <div class="modal-body">
        <div id="colorGrid" class="color-grid" role="grid" aria-label="Colors"></div>
      </div>
    </div>
  </div>

  <!-- AI Modal -->
  <div id="aiModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="aiTitle" hidden>
    <div class="modal-backdrop" data-action="close"></div>
    <div class="modal-panel">
      <div class="modal-header">
        <h3 id="aiTitle">AI Assistant</h3>
        <button id="aiClose" class="btn-icon" title="Close">×</button>
      </div>
      <div class="modal-body">
        <div id="aiMeta" class="ai-meta"></div>
        <label class="field">
          <span class="label">Instruction</span>
          <textarea id="aiInput" rows="4" placeholder="For example: Split the polygon into 2 equal areas; Divide the polygon into cells of 40,000 m²; Extend the line by 2 km to the northeast; Replace with 5 evenly spaced POIs along the line;"></textarea>
        </label>
        <div class="modal-row">
          <div id="aiSpinner" aria-hidden="true"></div>
          <div class="spacer"></div>
          <button id="aiSubmit" class="btn btn-primary">SUBMIT</button>
        </div>
        <div id="aiError" class="muted" role="alert" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <!-- Serial Monitor Modal -->
  <div id="serialMonitorModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="serialMonTitle" hidden>
    <div class="modal-backdrop" data-action="close"></div>
    <div class="modal-panel" style="width:min(820px,92vw);">
      <div class="modal-header">
        <h3 id="serialMonTitle">Serial Monitor</h3>
        <button id="serialMonitorClose" class="btn-icon" title="Close">×</button>
      </div>
      <div class="modal-body">
        <div class="modal-row" style="gap:12px; align-items:center;">
          <div class="muted">Connected:</div>
          <div id="serialConnPath" class="v">—</div>
          <div class="spacer"></div>
          <button id="serialMonitorClear" class="btn" type="button">Clear</button>
          <button id="serialDisconnectBtn" class="btn">Disconnect</button>
        </div>
        <pre id="serialMonitorBody" class="serial-float-body" aria-live="polite" style="height:40vh; border:1px solid var(--line); border-radius:8px; background: var(--bg);"></pre>
      </div>
    </div>
  </div>

  <!-- Mapbox GL JS (CSP build) -->
  <script src="./dist/vendor/mapbox-gl/mapbox-gl-csp.js"></script>
  <!-- Your renderer bundle goes here -->
  <script src="./renderer.js"></script>
</body>
</html>
