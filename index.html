<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline' https://api.mapbox.com; img-src 'self' data: blob: https://api.mapbox.com https://*.tiles.mapbox.com https://maps.gstatic.com https://maps.gstatic.com/*; font-src 'self' data: https://api.mapbox.com; script-src 'self'; connect-src 'self' data: blob: https://api.mapbox.com https://*.tiles.mapbox.com https://events.mapbox.com https://maps.googleapis.com https://places.googleapis.com https://geocoding.googleapis.com https://weather.googleapis.com https://firestore.googleapis.com; worker-src 'self' blob:;"
  />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Command - CYNOOPS</title>

  <!-- Your main app styles -->
  <link rel="stylesheet" href="./styles.css" />
  <link rel="stylesheet" href="./scale-dialog.css" />

  <!-- Mapbox GL CSS (bundled locally into dist/vendor) -->
  <link rel="stylesheet" href="./dist/vendor/mapbox-gl/mapbox-gl.css" />
</head>
<body>
  <div class="app">

    <!-- Header -->
    <header class="app-header">
      <nav class="main-menu" role="tablist" aria-label="Main view">
        <label class="tab" for="tab-map" role="tab" aria-controls="view-map" aria-selected="true">MAP</label>
        <label class="tab" for="tab-settings" role="tab" aria-controls="view-settings" aria-selected="false">Settings</label>
      </nav>

      <div class="app-toolbar" role="toolbar" aria-label="Map tools">
        <button id="toolSearch" class="tool-btn" title="Search address" aria-pressed="false" data-tooltip="Search address">
          <img class="icon" src="./assets/icons/regular/magnifying-glass.svg" alt="" aria-hidden="true" />
        </button>
        <button id="toolGoTo" class="tool-btn" title="Go to coordinates" aria-pressed="false" data-tooltip="Go to coordinates">
          <img class="icon" src="./assets/icons/regular/map-pin-line.svg" alt="" aria-hidden="true" />
        </button>
        <!-- View controls -->
        <button id="toolZoomIn" class="tool-btn" title="Zoom in" data-tooltip="Zoom in">
          <img class="icon" src="./assets/icons/regular/plus.svg" alt="" aria-hidden="true" />
        </button>
        <button id="toolZoomOut" class="tool-btn" title="Zoom out" data-tooltip="Zoom out">
          <img class="icon" src="./assets/icons/regular/minus.svg" alt="" aria-hidden="true" />
        </button>
        <button id="toolResetView" class="tool-btn" title="Reset bearing & pitch" data-tooltip="Reset bearing & pitch">
          <img class="icon" src="./assets/icons/regular/compass.svg" alt="" aria-hidden="true" />
        </button>
        <button id="toolPin" class="tool-btn" title="Pin/unpin map" aria-pressed="false" data-tooltip="Pin/unpin map">
          <img class="icon" src="./assets/icons/regular/lock.svg" alt="" aria-hidden="true" />
        </button>
        <div class="tool-divider" aria-hidden="true"></div>
        <button id="toolEdit" class="tool-btn" title="Edit features" aria-pressed="false" data-tooltip="Edit features">
          <img class="icon" src="./assets/icons/regular/arrows-out-cardinal.svg" alt="" aria-hidden="true" />
        </button>
        <button id="toolRect" class="tool-btn" title="Draw rectangle" aria-pressed="false" data-tooltip="Draw rectangle">
          <img class="icon" src="./assets/icons/regular/bounding-box.svg" alt="" aria-hidden="true" />
        </button>
        <button id="toolPoly" class="tool-btn" title="Draw polygon" aria-pressed="false" data-tooltip="Draw polygon">
          <img class="icon" src="./assets/icons/regular/polygon.svg" alt="" aria-hidden="true" />
        </button>
        <button id="toolCircle" class="tool-btn" title="Draw circle" aria-pressed="false" data-tooltip="Draw circle">
          <img class="icon" src="./assets/icons/regular/circle.svg" alt="" aria-hidden="true" />
        </button>
        <button id="toolLine" class="tool-btn" title="Draw polyline" aria-pressed="false" data-tooltip="Draw polyline">
          <img class="icon" src="./assets/icons/regular/line-segments.svg" alt="" aria-hidden="true" />
        </button>
        <button id="toolArrow" class="tool-btn" title="Draw arrow" aria-pressed="false" data-tooltip="Draw arrow">
          <img class="icon" src="./assets/icons/regular/arrow-fat-line-right.svg" alt="" aria-hidden="true" />
        </button>
        <!-- POI button sits next to Line -->
        <button id="toolPOI" class="tool-btn" title="Add POI" aria-pressed="false" data-tooltip="Add POI">
          <img class="icon" src="./assets/icons/regular/map-pin-plus.svg" alt="" aria-hidden="true" />
        </button>
        <div class="tool-divider" aria-hidden="true"></div>
        <button id="toolWeather" class="tool-btn" title="Sample weather" aria-pressed="false" data-tooltip="Sample weather">
          <img class="icon" src="./assets/icons/regular/cloud.svg" alt="" aria-hidden="true" />
        </button>
        <button id="toolCrosshair" class="tool-btn" title="Show coordinates" aria-pressed="false" data-tooltip="Show coordinates">
          <img class="icon" src="./assets/icons/regular/crosshair.svg" alt="" aria-hidden="true" />
        </button>
        <button id="toolSetScale" class="tool-btn" title="Set scale" aria-pressed="false" data-tooltip="Set scale">
          <img class="icon" src="./assets/icons/regular/ruler.svg" alt="" aria-hidden="true" />
        </button>
        <div class="tool-divider" aria-hidden="true"></div>
        <button id="toolLabelIncrease" class="tool-btn" title="Increase label & symbol size" aria-pressed="false" data-tooltip="Increase label & symbol size">
          <img class="icon" src="./assets/icons/regular/plus.svg" alt="" aria-hidden="true" />
        </button>
        <button id="toolLabelDecrease" class="tool-btn" title="Decrease label & symbol size" aria-pressed="false" data-tooltip="Decrease label & symbol size">
          <img class="icon" src="./assets/icons/regular/minus.svg" alt="" aria-hidden="true" />
        </button>
        <div class="tool-divider" aria-hidden="true"></div>
        <button id="toolPrint" class="tool-btn" title="Save snapshot" aria-pressed="false" data-tooltip="Save snapshot">
          <img class="icon" src="./assets/icons/regular/printer.svg" alt="" aria-hidden="true" />
        </button>
        <div class="tool-spacer"></div>
        <button id="toolShortcuts" class="tool-btn" title="Keyboard shortcuts" data-tooltip="Keyboard shortcuts">
          <img class="icon" src="./assets/icons/regular/keyboard.svg" alt="" aria-hidden="true" />
        </button>
      </div>

      <dialog id="scaleDialog" class="scale-dialog" aria-labelledby="scaleDialogTitle">
        <form method="dialog" class="scale-dialog__content">
          <header class="scale-dialog__header">
            <h2 id="scaleDialogTitle">Set map scale</h2>
            <button type="button" class="scale-dialog__close" data-action="close" aria-label="Close">
              <img class="icon" src="./assets/icons/regular/x.svg" alt="" aria-hidden="true" />
            </button>
          </header>
          <div class="scale-dialog__grid">
            <button type="button" class="scale-option" data-scale="2500">1:2,500</button>
            <button type="button" class="scale-option" data-scale="5000">1:5,000</button>
            <button type="button" class="scale-option" data-scale="10000">1:10,000</button>
            <button type="button" class="scale-option" data-scale="15000">1:15,000</button>
            <button type="button" class="scale-option" data-scale="20000">1:20,000</button>
            <button type="button" class="scale-option" data-scale="25000">1:25,000</button>
            <button type="button" class="scale-option" data-scale="50000">1:50,000</button>
          </div>
          <div class="scale-dialog__actions">
            <button type="submit" class="btn-secondary" value="cancel">Close</button>
          </div>
        </form>
      </dialog>

      <div class="actions">
        <div class="lang-dropdown" id="languageDropdown">
          <button class="btn-icon" id="languageToggle" type="button" aria-haspopup="true" aria-expanded="false" title="Change language" aria-label="Change language">
            <img class="icon" src="./assets/icons/regular/globe.svg" alt="" aria-hidden="true" />
          </button>
          <div class="lang-menu" id="languageMenu" role="menu" hidden>
          <button class="lang-menu-item" type="button" role="menuitem" data-lang="en">English</button>
          <button class="lang-menu-item" type="button" role="menuitem" data-lang="de">Deutsch</button>
          <button class="lang-menu-item" type="button" role="menuitem" data-lang="fr">Français</button>
          <button class="lang-menu-item" type="button" role="menuitem" data-lang="es">Español</button>
          <button class="lang-menu-item" type="button" role="menuitem" data-lang="it">Italiano</button>
          </div>
        </div>
        <button id="fullscreenBtn" class="action-btn" title="Toggle full screen" aria-label="Toggle full screen">
          <img class="icon" src="./assets/icons/regular/corners-out.svg" alt="" aria-hidden="true" />
        </button>
      </div>
    </header>

    <!-- Tabs (CSS-only) moved out of header so CSS sibling selectors work -->
    <input id="tab-map" type="radio" name="main-tabs" class="tab-input" checked />
    <input id="tab-settings" type="radio" name="main-tabs" class="tab-input" />



    <!-- Main content -->
    <main class="app-main">
      <!-- MAP VIEW -->
      <section id="view-map" class="view view-map" role="tabpanel" aria-labelledby="tab-map">
        <div id="mapWelcome" class="map-welcome" hidden>
          <div class="map-welcome-card" role="dialog" aria-labelledby="mapWelcomeTitle" aria-describedby="mapWelcomeDesc">
            <h2 id="mapWelcomeTitle">Welcome to CynoOps Command</h2>
            <p id="mapWelcomeDesc">To start exploring the map, add your Mapbox access token under <strong>Settings → API Keys</strong>. Once saved, the map will load automatically.</p>
            <ul class="map-welcome-todo">
              <li>Sign in at <a href="https://account.mapbox.com" target="_blank" rel="noopener">mapbox.com</a> and copy a public access token.</li>
              <li>Open the Settings tab and paste the token into the Mapbox Access Token field.</li>
              <li>Press <em>Save Settings</em> to initialize the map.</li>
            </ul>
            <div class="map-welcome-actions">
              <button id="mapWelcomeSettings" class="btn btn-primary" type="button">Open Settings</button>
            </div>
          </div>
        </div>
        <div id="map" class="map-container" aria-label="Interactive map">
          <!-- Crosshair overlay (placed inside container so it's always centered) -->
          <div id="mapCrosshair" class="map-crosshair" aria-hidden="false"></div>
        </div>
        <div class="map-overlay-menus" aria-label="Map overlays">
          <div class="map-overlay-combined">
            <div id="mapUtilityToolbar" class="map-utility-toolbar map-utility-toolbar--inline" aria-label="Map utilities">
              <button class="map-utility-btn is-active" type="button" data-tool="features" aria-pressed="true" data-tooltip="Features">
                <img src="./assets/icons/regular/polygon.svg" alt="" class="icon" aria-hidden="true" />
                <span class="visually-hidden">Toggle features</span>
              </button>
              <button class="map-utility-btn" type="button" aria-pressed="false" data-tool="cloud-sun" data-tooltip="Weather">
                <img src="./assets/icons/regular/cloud-sun.svg" alt="" class="icon" aria-hidden="true" />
                <span class="visually-hidden">Toggle weather overlay</span>
              </button>
              <button class="map-utility-btn is-active" type="button" data-tool="trackers" aria-pressed="true" data-tooltip="Teams">
                <img src="./assets/icons/regular/air-traffic-control.svg" alt="" class="icon" aria-hidden="true" />
                <span class="visually-hidden">Toggle teams</span>
              </button>
            </div>
            <div class="map-overlay-separator" aria-hidden="true"></div>
            <div id="mapSessionOverlay" class="map-session-overlay map-session-overlay--inline" aria-live="polite">
              <div class="map-session-info">
                <div id="mapSessionEmpty" class="map-session-empty" data-i18n="teams.noActiveSession">No active session</div>
                <div id="mapSessionActive" class="map-session-active" hidden>
                  <button id="mapSessionTitle" class="map-session-title map-session-title-button" type="button" aria-haspopup="dialog" aria-controls="teamsSessionActionsModal"></button>
                  <div id="mapSessionId" class="map-session-id" data-i18n-aria-label="sessionOverlay.idAria" aria-label="Session ID">—</div>
                </div>
              </div>
              <div class="map-session-actions">
                <button id="mapSessionStartBtn" class="btn btn-primary map-session-action" type="button" data-i18n="sessionOverlay.startNew">New</button>
                <button id="mapSessionResumeBtn" class="btn map-session-action" type="button" data-i18n="sessionOverlay.resume">Load</button>
              </div>
            </div>
            <div class="map-overlay-separator" aria-hidden="true"></div>
            <div id="mapStyleToolbar" class="map-utility-toolbar map-style-toolbar map-utility-toolbar--inline" aria-label="Map styles">
              <button class="map-utility-btn" type="button" aria-pressed="false" data-tool="street" data-tooltip="Street">
                <img src="./assets/icons/regular/road-horizon.svg" alt="" class="icon" aria-hidden="true" />
                <span class="visually-hidden">Toggle street map style</span>
              </button>
              <button class="map-utility-btn" type="button" aria-pressed="false" data-tool="terrain" data-tooltip="Terrain">
                <img src="./assets/icons/regular/mountains.svg" alt="" class="icon" aria-hidden="true" />
                <span class="visually-hidden">Toggle terrain map style</span>
              </button>
              <button class="map-utility-btn" type="button" aria-pressed="false" data-tool="satellite" data-tooltip="Satellite">
                <img src="./assets/icons/regular/map-trifold.svg" alt="" class="icon" aria-hidden="true" />
                <span class="visually-hidden">Toggle satellite map style</span>
              </button>
            </div>
          </div>
        </div>
        <!-- Location inputs panel removed -->
        <!-- Sidebar: Features -->
        <aside id="featuresSidebar" class="features-sidebar" aria-label="Features panel" hidden>
          <div class="features-header">
            <span class="features-title">Features</span>
            <div class="features-header-actions">
              <button id="featuresLabelsToggle" class="btn-icon" type="button" title="Toggle feature labels" aria-label="Toggle feature labels" aria-pressed="false">
                <img src="./assets/icons/regular/exam.svg" alt="" class="icon" aria-hidden="true" />
              </button>
              <button id="featuresCollapse" class="btn-icon" title="Hide sidebar" aria-label="Hide sidebar">⟨</button>
            </div>
          </div>
          <div id="drawingsList" class="features-list" aria-live="polite"></div>
          <div id="featuresActions" class="features-actions">
            <button id="featuresActionsToggle" class="features-actions-trigger" type="button" aria-haspopup="true" aria-expanded="false">
              <img src="./assets/icons/regular/dots-three-circle-vertical.svg" alt="" class="icon" aria-hidden="true" />
              <span class="visually-hidden">Open features menu</span>
            </button>
            <div id="featuresActionsMenu" class="features-actions-menu" role="menu" hidden>
              <button id="featuresSaveBtn" class="features-menu-btn" type="button" role="menuitem">
                <img src="./assets/icons/regular/file-text.svg" alt="" class="icon" aria-hidden="true" />
                <span>Save</span>
              </button>
              <button id="featuresLoadBtn" class="features-menu-btn" type="button" role="menuitem">
                <img src="./assets/icons/regular/folder-open.svg" alt="" class="icon" aria-hidden="true" />
                <span>Load</span>
              </button>
              <button id="featuresLoadGpxBtn" class="features-menu-btn" type="button" role="menuitem">
                <img src="./assets/icons/regular/path.svg" alt="" class="icon" aria-hidden="true" />
                <span>Load from GPX</span>
              </button>
              <button id="featuresClearBtn" class="features-menu-btn" type="button" role="menuitem">
                <img src="./assets/icons/regular/broom.svg" alt="" class="icon" aria-hidden="true" />
                <span>Clear</span>
              </button>
            </div>
          </div>
          <div id="featuresResizer" class="features-resizer" title="Drag to resize" aria-hidden="true"></div>
        </aside>
        <button id="featuresToggleBtn" class="sidebar-toggle sidebar-toggle-left" type="button" aria-controls="featuresSidebar" aria-expanded="false">
          <img src="./assets/icons/regular/caret-right.svg" alt="" class="icon icon-chevron" aria-hidden="true" />
          <span class="sidebar-toggle-label">FEATURES</span>
          <img src="./assets/icons/regular/polygon.svg" alt="" class="icon" aria-hidden="true" />
          <span class="visually-hidden">Show features panel</span>
        </button>
        <aside id="trackersSidebar" class="trackers-sidebar" aria-label="Teams panel" hidden>
          <div class="trackers-header">
            <span class="trackers-title">Teams</span>
            <div class="trackers-header-actions">
              <button id="trackersCollapse" class="btn-icon" title="Hide teams panel" aria-label="Hide teams panel">⟩</button>
            </div>
          </div>
          <div id="trackersList" class="trackers-list" aria-live="polite">
            <button id="teamsAddBtn" class="btn btn-primary btn-compact" type="button" data-i18n="teams.addMember" hidden>Add member</button>
            <div id="trackersItems" class="trackers-items"></div>
          </div>
        </aside>
        <button id="trackersToggleBtn" class="sidebar-toggle sidebar-toggle-right" type="button" aria-controls="trackersSidebar" aria-expanded="false">
          <img src="./assets/icons/regular/caret-left.svg" alt="" class="icon icon-chevron" aria-hidden="true" />
          <span class="sidebar-toggle-label">TEAMS</span>
          <img src="./assets/icons/regular/air-traffic-control.svg" alt="" class="icon" aria-hidden="true" />
          <span class="visually-hidden">Show teams panel</span>
        </button>
        <!-- You’ll initialize the map in your preload/renderer JS and update footer stats by ID -->
      </section>

      <!-- SETTINGS VIEW -->
      <section id="view-settings" class="view view-settings" role="tabpanel" aria-labelledby="tab-settings">
        <div class="panel settings-panel">
          <h2>Settings</h2>
          <form id="settingsForm" class="settings-form">
            <div class="settings-group">
              <h3>General</h3>
              <div class="settings-fields">
                <label class="field">
                  <span class="label">App Language</span>
                  <select id="settingLanguage" autocomplete="off">
                    <option value="en">English</option>
                    <option value="de">German</option>
                    <option value="fr">French</option>
                    <option value="es">Spanish</option>
                    <option value="it">Italian</option>
                  </select>
                </label>
              </div>
            </div>

            <div class="settings-group">
              <h3>API Keys</h3>
              <div class="settings-fields">
                <label class="field">
                  <span class="label label-with-help">Mapbox Access Token
                    <button type="button" class="label-help" aria-label="Where to find your Mapbox access token" data-tooltip="Sign in at mapbox.com, open your account dashboard, and copy a public access token.">info</button>
                  </span>
                  <input id="settingAccessToken" type="password" autocomplete="off" placeholder="pk.•••" />
                </label>
                <label class="field">
                  <span class="label label-with-help">Google Maps API Key
                    <button type="button" class="label-help" aria-label="How to get a Google Maps API key" data-tooltip="Use the Google Cloud Console to create a project, enable Maps JavaScript & Places APIs, then create an API key under Credentials.">info</button>
                  </span>
                  <input id="settingGoogleKey" type="password" autocomplete="off" placeholder="AIza•••" />
                </label>
                <label class="field">
                  <span class="label label-with-help">OpenAI API Key
                    <button type="button" class="label-help" aria-label="How to get an OpenAI API key" data-tooltip="Go to platform.openai.com/account/api-keys, create a new secret key, and paste it here.">info</button>
                  </span>
                  <input id="settingOpenAIKey" type="password" autocomplete="off" placeholder="sk-•••" />
                </label>
                <label class="field">
                  <span class="label" data-i18n="settings.firebaseConfig">Firebase Settings (JSON)</span>
                  <textarea id="settingFirebaseConfig" placeholder='{"apiKey":"...","authDomain":"...","projectId":"..."}'></textarea>
                </label>
              </div>
            </div>

            <div class="settings-group">
              <h3 data-i18n="settings.section.map">Map Settings</h3>
              <div class="settings-fields">
                <label class="field">
                  <span class="label" data-i18n="settings.streetStyleUrl">Street Map Style URL</span>
                  <input id="settingStyleUrl" type="text" placeholder="mapbox://styles/your-style-id" />
                </label>
                <label class="field">
                  <span class="label" data-i18n="settings.satelliteStyleUrl">Satellite Map Style URL</span>
                  <input id="settingSatelliteStyleUrl" type="text" placeholder="mapbox://styles/mapbox/standard-satellite" value="mapbox://styles/mapbox/standard-satellite" />
                </label>
                <label class="field">
                  <span class="label" data-i18n="settings.terrainStyleUrl">Terrain Map Style URL</span>
                  <input id="settingTerrainStyleUrl" type="text" placeholder="mapbox://styles/mapbox/outdoors-v12" value="mapbox://styles/mapbox/outdoors-v12" />
                </label>
                <label class="field">
                  <span class="label" data-i18n="settings.homeAddress">Home Address</span>
                  <input id="settingHomeAddress" type="text" placeholder="e.g., 1600 Amphitheatre Parkway, Mountain View, CA" />
                </label>
                <label class="field">
                  <span class="label" data-i18n="settings.startLatitude">Start Latitude</span>
                  <input id="settingStartLat" type="number" step="0.000001" min="-90" max="90" placeholder="49.610000" value="49.610000" />
                </label>
                <label class="field">
                  <span class="label" data-i18n="settings.startLongitude">Start Longitude</span>
                  <input id="settingStartLng" type="number" step="0.000001" min="-180" max="180" placeholder="6.130000" value="6.130000" />
                </label>
                <label class="field">
                  <span class="label" data-i18n="settings.startZoom">Start Zoom</span>
                  <input id="settingStartZoom" type="number" min="0" max="22" step="0.1" value="12" />
                </label>
                <label class="field">
                  <span class="label" data-i18n="settings.coordinateSystem">Coordinate System</span>
                  <select id="settingCoordinateSystem">
                    <option value="latlng" data-i18n="settings.coord.latlng">Lat/Long</option>
                    <option value="utm" data-i18n="settings.coord.utm">UTM</option>
                    <option value="gk" data-i18n="settings.coord.gk">GK</option>
                  </select>
                </label>
              </div>
            </div>

            <div class="settings-actions">
              <span class="settings-status" aria-live="polite"></span>
              <button id="settingsSaveBtn" class="btn btn-primary" type="submit" disabled>Save Settings</button>
            </div>
          </form>
        </div>
      </section>
    </main>

    <!-- Footer: map & data stats -->
    <footer class="app-footer" aria-live="polite">
      <div class="stat"><span class="k">Lat/Long</span><span id="statCenter" class="v">—</span></div>
      <div class="stat"><span class="k">Zoom</span><span id="statZoom" class="v">—</span></div>
      <div class="stat"><span class="k">Scale</span><span id="statScale" class="v">—</span></div>
      <div class="stat"><span class="k">Bearing</span><span id="statBearing" class="v">—</span></div>
      <div class="stat"><span class="k">Pitch</span><span id="statPitch" class="v">—</span></div>
      <div class="stat" style="justify-self:end; text-align:right;">
        <span class="k">Address</span>
        <span id="footerAddress" class="v">—</span>
      </div>
    </footer>
    <div id="toastContainer" class="toast-container" aria-live="polite"></div>
  </div>

  <!-- Coordinates Modal -->
  <div id="coordModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="coordTitle" hidden>
    <div class="modal-backdrop" data-action="close"></div>
    <div class="modal-panel" style="width:min(800px, 96vw);">
      <div class="modal-header">
        <h3 id="coordTitle" data-i18n="coordModal.title">Coordinates</h3>
        <button id="coordClose" class="btn-icon" title="Close">×</button>
      </div>
      <div class="modal-body">
        <div id="coordList" class="coord-list"></div>
      </div>
      <div class="modal-footer coord-footer">
        <label class="coord-target">
          <span class="visually-hidden" data-i18n="coordModal.targetLabel">Choose map provider</span>
          <select id="coordProvider" data-i18n-placeholder="coordModal.targetLabel">
            <option value="google-maps" data-i18n="coordModal.openGoogleMaps">Google Maps</option>
            <option value="openstreetmap" data-i18n="coordModal.openOSM">OpenStreetMap</option>
            <option value="bing" data-i18n="coordModal.openBing">Bing Maps</option>
            <option value="arcgis" data-i18n="coordModal.openArcgis">ArcGIS Maps</option>
          </select>
        </label>
        <button id="coordOpenProvider" class="btn coord-open-btn" type="button" data-i18n="coordModal.openInBrowser">Open in browser</button>
      </div>
    </div>
  </div>

  <!-- Search Modal -->
  <div id="searchModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="searchTitle" hidden>
    <div class="modal-backdrop" data-action="close"></div>
    <div class="modal-panel">
      <div class="modal-header">
        <h3 id="searchTitle">Search Address</h3>
        <button id="searchClose" class="btn-icon" title="Close">×</button>
      </div>
      <div class="modal-body">
        <label class="field">
          <span class="label">Address</span>
          <input id="searchQuery" type="text" placeholder="Type an address" autocomplete="off" />
        </label>
        <div id="searchResults" class="search-results" role="listbox" aria-label="Search results"></div>
      </div>
    </div>
  </div>

  <!-- Go To Coordinates Modal -->
  <div id="gotoModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="gotoTitle" hidden>
    <div class="modal-backdrop" data-action="close"></div>
    <div class="modal-panel">
      <div class="modal-header">
        <h3 id="gotoTitle">Go to coordinates</h3>
        <button id="gotoClose" class="btn-icon" title="Close">×</button>
      </div>
      <div class="modal-body">
        <div id="gotoFieldsLatLng" class="goto-fields">
          <label class="field">
            <span class="label" data-i18n="gotoModal.latitude">Latitude</span>
            <input id="gotoLat" type="number" step="0.000001" min="-90" max="90" placeholder="e.g., 49.6100" />
          </label>
          <label class="field">
            <span class="label" data-i18n="gotoModal.longitude">Longitude</span>
            <input id="gotoLng" type="number" step="0.000001" min="-180" max="180" placeholder="e.g., 6.1300" />
          </label>
        </div>
        <div id="gotoFieldsUTM" class="goto-fields" hidden>
          <label class="field">
            <span class="label" data-i18n="gotoModal.utmZone">UTM Zone</span>
            <input id="gotoUtmZone" type="text" maxlength="4" placeholder="32U" />
          </label>
          <label class="field">
            <span class="label" data-i18n="gotoModal.utmEasting">Easting (mE)</span>
            <input id="gotoUtmEasting" type="number" step="1" placeholder="445000" />
          </label>
          <label class="field">
            <span class="label" data-i18n="gotoModal.utmNorthing">Northing (mN)</span>
            <input id="gotoUtmNorthing" type="number" step="1" placeholder="5412000" />
          </label>
        </div>
        <div id="gotoFieldsGK" class="goto-fields" hidden>
          <label class="field">
            <span class="label" data-i18n="gotoModal.gkZone">GK Zone</span>
            <input id="gotoGkZone" type="number" min="0" max="60" step="1" placeholder="2" />
          </label>
          <label class="field">
            <span class="label" data-i18n="gotoModal.gkEasting">Easting (m)</span>
            <input id="gotoGkEasting" type="number" step="1" placeholder="3450000" />
          </label>
          <label class="field">
            <span class="label" data-i18n="gotoModal.gkNorthing">Northing (m)</span>
            <input id="gotoGkNorthing" type="number" step="1" placeholder="5483000" />
          </label>
        </div>
        <div class="switch-field">
          <span id="gotoAddPoiLabel" class="label">Add POI at this location</span>
          <label class="switch">
            <input id="gotoAddPoi" type="checkbox" role="switch" aria-labelledby="gotoAddPoiLabel" aria-checked="false" />
            <span class="switch-track"><span class="switch-handle"></span></span>
          </label>
        </div>
        <label id="gotoPoiNameField" class="field" hidden>
          <span class="label">POI name</span>
          <input id="gotoPoiName" type="text" placeholder="Optional name" />
        </label>
        <div class="modal-row">
          <div class="spacer"></div>
          <button id="gotoSubmit" class="btn btn-primary">Go</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Team Member Modal -->
  <div id="teamMemberModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="teamMemberTitle" hidden>
    <div class="modal-backdrop" data-action="close"></div>
    <div class="modal-panel" style="width:min(520px, 92vw);">
      <div class="modal-header">
        <h3 id="teamMemberTitle" data-i18n="teams.memberModal.title">Add team member</h3>
        <button id="teamMemberClose" class="btn-icon" title="Close" data-i18n-title="common.close">×</button>
      </div>
      <div class="modal-body team-member-body">
        <div id="teamMemberStatus" class="muted" data-i18n="teams.memberModal.subtitle">Scan this QR code to join the team.</div>
        <div class="team-member-preview">
          <img id="teamMemberQr" src="" alt="Team member QR code" />
        </div>
        <button id="teamMemberStart" class="btn btn-primary" type="button" data-i18n="teams.memberModal.startTracking">Start tracking</button>
      </div>
      <div class="modal-footer team-member-actions">
        <button id="teamMemberDone" class="btn" type="button" data-i18n="common.close">Close</button>
      </div>
    </div>
  </div>

  <!-- Start Team Session Modal -->
  <div id="teamsStartSessionModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="teamsStartSessionTitle" hidden>
    <div class="modal-backdrop" data-action="close"></div>
    <div class="modal-panel" style="width:min(520px, 92vw);">
      <div class="modal-header">
        <h3 id="teamsStartSessionTitle" data-i18n="teams.startSessionModal.title">Start Session</h3>
        <button id="teamsStartSessionClose" class="btn-icon" title="Close" data-i18n-title="common.close">×</button>
      </div>
      <form id="teamsStartSessionForm" class="modal-body">
        <label class="field">
          <span class="label" data-i18n="teams.startSessionModal.label">Session title</span>
          <input id="teamsStartSessionTitleInput" type="text" autocomplete="off" data-i18n-placeholder="teams.startSessionModal.placeholder" placeholder="e.g., Mountain Rescue A" />
        </label>
        <div class="modal-row">
          <div class="spacer"></div>
          <button id="teamsStartSessionCancel" class="btn" type="button" data-i18n="teams.startSessionModal.cancel">Cancel</button>
          <button id="teamsStartSessionSubmit" class="btn btn-primary" type="submit" data-i18n="teams.startSessionModal.submit">Create Session</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Load Team Session Modal -->
  <div id="teamsResumeSessionModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="teamsResumeSessionTitle" hidden>
    <div class="modal-backdrop" data-action="close"></div>
    <div class="modal-panel" style="width:min(720px, 94vw);">
      <div class="modal-header">
        <h3 id="teamsResumeSessionTitle" data-i18n="teams.loadSessionModal.title">Load Session</h3>
        <button id="teamsResumeSessionClose" class="btn-icon" title="Close" data-i18n-title="common.close">×</button>
      </div>
      <div class="modal-body">
        <div id="teamsLoadSessionStatus" class="muted" role="status" aria-live="polite" data-i18n="teams.loadSessionModal.loading">Loading sessions...</div>
        <div id="teamsLoadSessionList" class="session-list" role="list" aria-live="polite"></div>
        <div class="modal-row">
          <div class="spacer"></div>
          <button id="teamsResumeSessionCancel" class="btn" type="button" data-i18n="common.close">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Session Actions Modal -->
  <div id="teamsSessionActionsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="teamsSessionActionsTitle" hidden>
    <div class="modal-backdrop" data-action="close"></div>
    <div class="modal-panel" style="width:min(520px, 92vw);">
      <div class="modal-header">
        <h3 id="teamsSessionActionsTitle" data-i18n="teams.sessionActionsModal.title">Session actions</h3>
        <button id="teamsSessionActionsClose" class="btn-icon" title="Close" data-i18n-title="common.close">×</button>
      </div>
      <div class="modal-body session-actions-body">
        <div class="session-actions-meta">
          <div class="session-actions-id">
            <span class="session-actions-id-label" data-i18n="teams.sessionActionsModal.sessionIdLabel">Session ID</span>
            <span id="teamsSessionActionsId" class="session-actions-id-value">—</span>
          </div>
        </div>
        <form id="teamsSessionRenameForm" class="session-actions-group session-actions-group--rename">
          <div class="session-actions-rename-row">
            <label class="field">
              <span class="label" data-i18n="teams.sessionActionsModal.renameLabel">Session name</span>
              <input id="teamsSessionRenameInput" type="text" autocomplete="off" data-i18n-placeholder="teams.sessionActionsModal.renamePlaceholder" placeholder="e.g., Operation Alpha" />
            </label>
            <button id="teamsSessionRenameSubmit" class="btn btn-primary" type="submit" data-i18n="features.menu.save">Save</button>
          </div>
        </form>
        <div class="session-actions-group session-actions-group--stop">
          <div class="session-actions-copy">
            <p class="modal-text" data-i18n="teams.sessionActionsModal.stopHint">Stop this session by adding an end date.</p>
          </div>
          <div class="session-actions-cta">
            <button id="teamsSessionStopAction" class="btn btn-danger" type="button" data-i18n="teams.sessionActionsModal.stopButton">Stop session</button>
          </div>
        </div>
        <div class="session-actions-group session-actions-group--close">
          <div class="session-actions-copy">
            <p class="modal-text" data-i18n="teams.sessionActionsModal.closeHint">Close the session and reset the map, features, and teams. GPX stays.</p>
          </div>
          <div class="session-actions-cta">
            <button id="teamsSessionCloseAction" class="btn" type="button" data-i18n="teams.sessionActionsModal.closeButton">Close session</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Team Session Modal -->
  <div id="teamsDeleteSessionModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="teamsDeleteSessionTitle" hidden>
    <div class="modal-backdrop" data-action="close"></div>
    <div class="modal-panel" style="width:min(420px, 90vw);">
      <div class="modal-header">
        <h3 id="teamsDeleteSessionTitle" data-i18n="teams.deleteSessionModal.title">Delete session?</h3>
        <button id="teamsDeleteSessionClose" class="btn-icon" title="Close" data-i18n-title="common.close">×</button>
      </div>
      <div class="modal-body">
        <p id="teamsDeleteSessionMessage" class="modal-text" data-i18n="teams.deleteSessionModal.message">Are you sure you want to delete this session and all its data?</p>
        <p id="teamsDeleteSessionWarning" class="modal-text modal-text-danger" data-i18n="teams.deleteSessionModal.warning">Danger: this cannot be undone.</p>
        <div id="teamsDeleteSessionMeta" class="modal-text muted" aria-live="polite"></div>
        <div id="teamsDeleteSessionStatus" class="muted" role="status" aria-live="polite" hidden></div>
        <div class="modal-row">
          <div class="spacer"></div>
          <button id="teamsDeleteSessionCancel" class="btn" type="button" data-i18n="teams.deleteSessionModal.cancel">Cancel</button>
          <button id="teamsDeleteSessionConfirm" class="btn btn-danger" type="button" data-i18n="teams.deleteSessionModal.confirm">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Keyboard Shortcuts Modal -->
  <div id="shortcutsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="shortcutsTitle" hidden>
    <div class="modal-backdrop" data-action="close"></div>
    <div class="modal-panel">
      <div class="modal-header">
        <h3 id="shortcutsTitle">Keyboard Shortcuts</h3>
        <button id="shortcutsClose" class="btn-icon" title="Close">×</button>
      </div>
      <div class="modal-body">
        <div id="shortcutsList" class="shortcut-grid" role="list"></div>
      </div>
    </div>
  </div>

  <!-- Color Picker Modal -->
  <div id="colorModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="colorTitle" hidden>
    <div class="modal-backdrop" data-action="close"></div>
    <div class="modal-panel">
      <div class="modal-header">
        <h3 id="colorTitle">Pick Color</h3>
        <button id="colorClose" class="btn-icon" title="Close">×</button>
      </div>
      <div class="modal-body">
        <div id="colorGrid" class="color-grid" role="grid" aria-label="Colors"></div>
      </div>
    </div>
  </div>

  <!-- POI Icon Modal -->
  <div id="poiIconModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="poiIconTitle" hidden>
    <div class="modal-backdrop" data-action="close"></div>
    <div class="modal-panel">
      <div class="modal-header">
        <h3 id="poiIconTitle">POI Symbol</h3>
        <button id="poiIconClose" class="btn-icon" title="Close">×</button>
      </div>
      <div class="modal-body">
        <div id="poiIconStatus" class="muted" role="status" aria-live="polite"></div>
        <div id="poiIconGrid" class="poi-icon-grid" role="grid" aria-label="POI symbols"></div>
      </div>
    </div>
  </div>

  <!-- AI Modal -->
  <div id="aiModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="aiTitle" hidden>
    <div class="modal-backdrop" data-action="close"></div>
    <div class="modal-panel">
      <div class="modal-header">
        <h3 id="aiTitle">AI Assistant</h3>
        <button id="aiClose" class="btn-icon" title="Close">×</button>
      </div>
      <div class="modal-body">
        <div id="aiMeta" class="ai-meta"></div>
        <label class="field">
          <span class="label">Suggested modification</span>
          <select id="aiPreset"></select>
        </label>
        <label class="field" id="aiValueField" hidden>
          <span class="label">Value</span>
          <input id="aiValueInput" type="number" step="0.01" />
        </label>
        <label class="field" id="aiDirectionField" hidden>
          <span class="label">Direction</span>
          <select id="aiDirectionSelect">
            <option value="north">North</option>
            <option value="east">East</option>
            <option value="south">South</option>
            <option value="west">West</option>
          </select>
        </label>
        <label class="field">
          <span class="label">Instruction</span>
          <textarea id="aiInput" rows="4" placeholder="Add custom instructions for the AI (optional)"></textarea>
        </label>
        <label class="field">
          <span class="label">Additional modifiers (optional)</span>
          <textarea id="aiModifiers" rows="3" placeholder="Add any extra constraints or details you'd like the AI to consider."></textarea>
        </label>
        <label class="field field-inline">
          <input id="aiReplaceOriginal" type="checkbox" />
          <span>Replace original geometry</span>
        </label>
        <div class="modal-row">
          <div id="aiSpinner" aria-hidden="true"></div>
          <div class="spacer"></div>
          <button id="aiSubmit" class="btn btn-primary">SUBMIT</button>
        </div>
        <div id="aiError" class="muted" role="alert" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <!-- Mapbox GL JS (CSP build) -->
  <script src="./dist/vendor/mapbox-gl/mapbox-gl-csp.js"></script>
  <script src="./dist/vendor/qrcode-generator.js"></script>
  <script src="./dist/vendor/firebase/firebase-app-compat.js"></script>
  <script src="./dist/vendor/firebase/firebase-firestore-compat.js"></script>
  <!-- Your renderer bundle goes here -->
  <script src="./renderer.js"></script>
</body>
</html>
